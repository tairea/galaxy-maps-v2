rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    
    
    function isAdmin() {
      return isAuthenticated() && 
        "admin" in request.auth.token &&
        request.auth.token.admin == true;
    }
    
    // Check if user is accessing their own profile
    function isOwnProfile(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // People collection - main user profiles
    match /people/{userId} {
      // Users can always read/write their own profile (including initial creation)
      allow read, write: if isOwnProfile(userId);
      
      // Admins can manage all users
      allow read, write: if isAdmin();
      
      // Any authenticated user can read any profile (but not write)
      allow read, create: if isAuthenticated();
    }
    
    // People subcollections (if any)
    match /people/{userId}/{document=**} {
      // Users can always read/write their own profile subcollections
      allow read, write: if isOwnProfile(userId);
      
      // Admins can manage all user subcollections
      allow read, write: if isAdmin();
      
      // Any authenticated user can read any profile subcollection (but not write)
      allow read, create: if isAuthenticated();
    }
    
    // Cohorts collection with recursive wildcard for all subcollections
    match /cohorts/{cohortId} {
      allow read: if isAuthenticated();
      allow write: if isTeacherInCohort(cohortId) || isAdmin();
      allow create, update: if isAuthenticated();
    }
    
    // Cohorts subcollections
    match /cohorts/{cohortId}/{document=**} {
      allow read: if isStudent(cohortId) || isTeacherInCohort(cohortId) || isAdmin();
      allow write: if isTeacherInCohort(cohortId) || isAdmin();
      allow create, update: if isAuthenticated();
    }
    
    // Courses documents
    match /courses/{courseId} {
      allow read: if coursePublicAccess(courseId) || canEditCourse(courseId) || isAssignedToCourse(courseId) || isAdmin();
      // Anyone signed in can create a course
      allow create: if isAuthenticated();
      // Only owner, contentBy, or mappedBy can edit
      allow update, delete: if canEditCourse(courseId) || isAdmin();
    }
    


    // Specific rule for requestsForHelp subcollection
    // This must come BEFORE the wildcard rule below
    match /courses/{courseId}/requestsForHelp/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Specific rule for submissionsForReview subcollection
    // This must come BEFORE the wildcard rule below
    match /courses/{courseId}/submissionsForReview/{submissionId} {
      allow read, write: if isAuthenticated();
    }

    // Course subcollections wildcard rule (covers all other subcollections)
    // Note: This rule comes AFTER the specific rules above to avoid conflicts
    match /courses/{courseId}/{document=**} {
      allow read: if coursePublicAccess(courseId) || canEditCourse(courseId) || isAssignedToCourse(courseId) || isAdmin();
      allow write: if canEditCourse(courseId) || isAdmin();
    }
    
    // Status collection (for user presence/status)
    match /status/{statusId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Organisations collection
    match /organisations/{organisationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Slugs collection (course identifiers)
    match /slugs/{slugId} {
      allow read: if true;
      allow write: if isAdmin() || 
        (exists(/databases/$(database)/documents/slugs/$(slugId)) &&
        get(/databases/$(database)/documents/slugs/$(slugId)).data.owner == request.auth.uid);
    }
    
    // Helper function: Check if user is a student in the cohort
    function isStudent(cohortId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/cohorts/$(cohortId)) &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.students != null &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.students.hasAny([request.auth.uid]);
    }
    
    // Helper function: Check if user is a teacher in the cohort
    function isTeacherInCohort(cohortId) {
      return exists(/databases/$(database)/documents/cohorts/$(cohortId)) &&
             isAuthenticated() &&
             get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers != null &&
             get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers.hasAny([request.auth.uid]);
    }
    
    
    // Helper function: Determine read access to Public course and its subcollections
    function coursePublicAccess(courseId) {
      return exists(/databases/$(database)/documents/courses/$(courseId)) && (
        (get(/databases/$(database)/documents/courses/$(courseId)).data.status != null && 
         get(/databases/$(database)/documents/courses/$(courseId)).data.status == "published") &&
        (get(/databases/$(database)/documents/courses/$(courseId)).data.public == true || 
         get(/databases/$(database)/documents/courses/$(courseId)).data.presentationOnly == true)
      );
    }
    
    // Helper function: Check if user is assigned to a course
    function isAssignedToCourse(courseId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/people/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/people/$(request.auth.uid)).data.assignedCourses != null &&
        get(/databases/$(database)/documents/people/$(request.auth.uid)).data.assignedCourses.hasAny([courseId]);
    }
    
    // Helper function: Determine write access to course and subcollections
    // Only owner, contentBy.personId, or mappedBy.personId can edit (TODO: add collaboratorIds includes request.auth.uid)
    function canEditCourse(courseId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/courses/$(courseId)) && (
          (get(/databases/$(database)/documents/courses/$(courseId)).data.owner != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.owner) ||
          (get(/databases/$(database)/documents/courses/$(courseId)).data.contentBy != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.contentBy.personId) ||
          (get(/databases/$(database)/documents/courses/$(courseId)).data.mappedBy != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.mappedBy.personId)
        );
    }


    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
