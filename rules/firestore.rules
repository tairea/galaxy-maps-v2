rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    
    
    function isAdmin() {
      return isAuthenticated() && 
        "admin" in request.auth.token &&
        request.auth.token.admin == true;
    }
    
    // Check if user is accessing their own profile
    function isOwnProfile(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is a teacher of a specific cohort
    function isTeacherOfCohort(cohortId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/cohorts/$(cohortId)) &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers != null &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers.hasAny([request.auth.uid]);
    }
    
    // People collection - main user profiles
    match /people/{userId} {
      // Users can always read/write their own profile (including initial creation)
      allow read, write: if isOwnProfile(userId);
      
      // Admins can manage all users
      allow read, write: if isAdmin();
      
      // Any authenticated user can read any profile (but not write)
      allow read, create: if isAuthenticated();
    }
    
    // People subcollections (if any)
    match /people/{userId}/{document=**} {
      // Users can always read/write their own profile subcollections
      allow read, write: if isOwnProfile(userId);
      
      // Admins can manage all user subcollections
      allow read, write: if isAdmin();
      
      // Any authenticated user can read any profile subcollection (but not write)
      allow read, create: if isAuthenticated();
    }
    
    // Cohorts collection with recursive wildcard for all subcollections
    match /cohorts/{cohortId=**} {
      allow read: if isStudent(cohortId) || isTeacherInCohort(cohortId) || isAdmin();
      allow write: if isTeacherInCohort(cohortId) || isAdmin();
      allow create: if isAuthenticated();
    }
    
    // Courses documents
    match /courses/{courseId} {
      allow read: if coursePublicAccess(courseId) || canEditCourse(courseId) || isAdmin();
      // Anyone signed in can create a course
      allow create: if isAuthenticated();
      // Only owner, contentBy, or mappedBy can edit
      allow update, delete: if canEditCourse(courseId) || isAdmin();
    }
    
    // Topics subcollection under courses
    match /courses/{courseId}/topics/{topicId} {
      allow read: if coursePublicAccess(courseId) || canEditCourse(courseId) || isAdmin();
      allow write: if canEditCourse(courseId) || isAdmin();
    }

    // Topics/Tasks subcollection under courses
    match /courses/{courseId}/topics/{topicId}/tasks/{taskId} {
      allow read: if assignedToCourse(courseId) || canEditCourse(courseId) || isAdmin();
      allow write: if canEditCourse(courseId) || isAdmin();
    }
    
    // Specific rule for requestsForHelp subcollection
    match /courses/{courseId}/requestsForHelp/{requestId} {
      allow read, write: if isAuthenticated();
    }
    
    // Specific rule for submissionsForReview subcollection
    match /courses/{courseId}/submissionsForReview/{submissionId} {
      allow read, write: if isAuthenticated();
    }
    
    // Slugs collection (course identifiers)
    match /slugs/{slugId} {
      allow read: if true;
      allow write: if isAdmin() || 
        exists(/databases/$(database)/documents/slugs/$(slugId)) &&
        get(/databases/$(database)/documents/slugs/$(slugId)).data.owner.path == 
        '/databases/$(database)/documents/people/$(request.auth.uid)';
    }
    
    // Helper function: Check if user is a student in the cohort
    function isStudent(cohortId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/cohorts/$(cohortId)) &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.students != null &&
        get(/databases/$(database)/documents/cohorts/$(cohortId)).data.students.hasAny([request.auth.uid]);
    }
    
    // Helper function: Check if user is a teacher in the cohort
    function isTeacherInCohort(cohortId) {
      return exists(/databases/$(database)/documents/cohorts/$(cohortId)) &&
             isAuthenticated() &&
             get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers != null &&
             get(/databases/$(database)/documents/cohorts/$(cohortId)).data.teachers.hasAny([request.auth.uid]);
    }
    
    
    // Helper function: Determine read access to Public course and its subcollections
    function coursePublicAccess(courseId) {
      return exists(/databases/$(database)/documents/courses/$(courseId)) && (
        (get(/databases/$(database)/documents/courses/$(courseId)).data.status != null && 
         get(/databases/$(database)/documents/courses/$(courseId)).data.status == "published" &&
        (get(/databases/$(database)/documents/courses/$(courseId)).data.public == true || 
         get(/databases/$(database)/documents/courses/$(courseId)).data.presentationOnly == true))
      );
    }
    
    // Helper function: Determine write access to course and subcollections
    // Only owner, contentBy, or mappedBy can edit
    function canEditCourse(courseId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/courses/$(courseId)) && (
          (get(/databases/$(database)/documents/courses/$(courseId)).data.owner != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.owner) ||
          (get(/databases/$(database)/documents/courses/$(courseId)).data.contentBy != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.contentBy) ||
          (get(/databases/$(database)/documents/courses/$(courseId)).data.mappedBy != null && 
           request.auth.uid == get(/databases/$(database)/documents/courses/$(courseId)).data.mappedBy)
        );
    }

    // Helper function: Determine is student is assigned to course '
    function assignedToCourse(courseId) {
        return isAuthenticated() && 
          exists(/databases/$(database)/documents/people/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/people/$(request.auth.uid)).data.assignedCourses != null &&
           get(/databases/$(database)/documents/people/$(request.auth.uid)).data.assignedCourses.hasAny([courseId])
    }
    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
